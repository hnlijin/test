var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var n=(__define,t),i=n.prototype;return i.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},i.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.onAddToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},i.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},i.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},i.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},i.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},i.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},i.createGameScene=function(){var e={};e.server_info={},e.server_info.host="192.168.31.118",e.server_info.host="10.0.33.163",e.server_info.port=9001,e.map={},(new Game).startup(this,e)},t}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var Game=function(){function e(){}var t=(__define,e),n=t.prototype;return n.startup=function(e,t){var n=new GameScene(e);n.data=t,n.setBackground(new MapBackground),n.addComponent("net",new NetSevice(t.server_info.host,t.server_info.port)),n.addComponent("logic",new GameLogicComponent(n)),GameScene.currentScene=n},e}();egret.registerClass(Game,"Game");var Component=function(e){function t(){e.call(this)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.onEnter=function(){},i.onEixt=function(){},t}(egret.EventDispatcher);egret.registerClass(Component,"Component");var GameMap=function(e){function t(){e.call(this),this._map={}}__extends(t,e);var n=(__define,t),i=n.prototype;return i.addGameObject=function(e){var t=e.data.id;this.addChild(e),this._map[t]=e},i.removeGameObject=function(e){var t=e.data.id;e.removeAllComponent(),this.removeChild(e),delete this._map[t]},i.removeGameObjectForId=function(e){var t=this._map[e];null!=t&&this.removeGameObject(t)},i.getGameObjectForId=function(e){return this._map[e]},i.removeAllGameObject=function(){var e=0;for(var t in this._map)e=parseInt(t),console.log(e,typeof e),this.removeGameObjectForId(e)},t}(egret.DisplayObjectContainer);egret.registerClass(GameMap,"GameMap");var GameObject=function(e){function t(t,n){e.call(this),this._map=null,this._data=null,this._components={},this._map=t,this._data=n}__extends(t,e);var n=__define,i=t,o=i.prototype;return o.updatePosition=function(e,t){this.x=e,this.y=t},n(o,"data",function(){return this._data}),o.addComponent=function(e,t){this._components[e]=t,t.onEnter()},o.getComponent=function(e){return this._components[e]},o.removeComponent=function(e){var t=this._components[e];null!=t&&(t.onEixt(),delete this._components[e])},o.removeAllComponent=function(){for(var e in this._components)this.removeComponent(e)},t}(egret.DisplayObjectContainer);egret.registerClass(GameObject,"GameObject");var GameScene=function(){function e(e){this._background=null,this._gameMap=null,this._ui=null,this._tip=null,this._components={},this._data=null,this._background=new egret.DisplayObjectContainer,this._gameMap=new GameMap,this._ui=new egret.DisplayObjectContainer,this._tip=new egret.DisplayObjectContainer,e.addChild(this._background),e.addChild(this._gameMap),e.addChild(this._ui),e.addChild(this._tip)}var t=__define,n=e,i=n.prototype;return t(e,"currentScene",function(){return e._currentScene},function(t){e._currentScene=t}),t(i,"data",function(){return this._data},function(e){this._data=e}),i.addComponent=function(e,t){this._components[e]=t,t.onEnter()},i.getComponent=function(e){return this._components[e]},i.removeComponent=function(e){var t=this._components[e];null!=t&&(t.onEixt(),delete this._components[e])},i.removeAllComponent=function(){for(var e in this._components)this.removeComponent(e)},t(i,"map",function(){return this._gameMap}),i.setBackground=function(e){this._background.removeChildren(),this._background.addChildAt(e,0)},e._currentScene=null,e}();egret.registerClass(GameScene,"GameScene");var GameFactory=function(){function e(){}var t=(__define,e);t.prototype;return e.createGameObject=function(e,t){if(null!=t){var n=new GameObject(e,t);return n.addComponent("view",new PlayerView(n)),n}return null},e}();egret.registerClass(GameFactory,"GameFactory");var GameLogicComponent=function(e){function t(t){e.call(this),this._ower=null,this._netSevice=null,this._ower=t,this._netSevice=this._ower.getComponent("net"),this._netSevice.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.onReceiveMessage=function(e){var n=0,i=e.data,o=i.dataView.getUint8(n);switch(console.log("packetId:",o),o){case t.ADD_PLAYER:n+=1;var r=i.dataView.getUint8(n),a="";n+=1;var s=i.dataView.getUint8(n);n+=1;for(var c=0;s>c;c+=1){var d=i.dataView.getUint16(2*c+n,!0);if(0==d)break;a+=String.fromCharCode(d)}console.log("add_player:",r,s,a);var h={};h.id=r,h.name=a,GameFactory.createGameObject(this._ower.map,h),this._ower.map.addGameObject(g);break;case t.REMOVE_PALYER:var r=i.dataView.getUint8(n+=1);console.log("remove_player:",r),r>0&&this._ower.map.removeGameObjectForId(r);break;case t.UPDATE_PLAYER:for(var s=i.dataView.getUint8(n+=1),c=0;s>c;c+=1){var r=i.dataView.getUint8(n+=1),l=i.dataView.getUint8(n+=1),u=i.dataView.getUint8(n+=1);if(r>0){var g=this._ower.map.getGameObjectForId(r);null!=g&&g.updatePosition(l,u)}}break;case t.UPDATE_FISH:}},t.GAME_READY=1,t.GAME_START=2,t.ADD_PLAYER=10,t.REMOVE_PALYER=11,t.UPDATE_PLAYER=12,t.UPDATE_FISH=13,t}(Component);egret.registerClass(GameLogicComponent,"GameLogicComponent");var MapBackground=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStge,this)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.onAddToStge=function(e){this.stage.addEventListener(egret.Event.RESIZE,this.onStageResize,this),this.onResize()},i.onStageResize=function(e){this.onResize()},i.onResize=function(){this.graphics.clear(),this.graphics.beginFill(65280),this.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),this.graphics.endFill()},t}(egret.Sprite);egret.registerClass(MapBackground,"MapBackground");var NetSevice=function(e){function t(t,n){e.call(this),this.webSocket=null,this.webSocket=new egret.WebSocket,this.webSocket.type=egret.WebSocket.TYPE_BINARY,this.webSocket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),this.webSocket.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this.webSocket.addEventListener(egret.Event.CLOSE,this.onSocketClose,this),this.webSocket.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onSockeError,this),this.webSocket.connect(t,n)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.onReceiveMessage=function(e){var t=new egret.ByteArray;this.webSocket.readBytes(t),e.data=t,this.dispatchEvent(e)},i.onSocketOpen=function(e){console.log("Socket连接成功！")},i.onSocketClose=function(e){console.log("Socket连接断开！")},i.onSockeError=function(e){console.log("Socket连接出错！")},t}(Component);egret.registerClass(NetSevice,"NetSevice");var PlayerView=function(e){function t(t){e.call(this),this.gameObject=t,this.view=new egret.Sprite,this.gameObject.addChild(this.view),this.label=new egret.TextField,this.label.textColor=65280,this.label.text=this.gameObject.data.name,this.view.addChild(this.label)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.onEnter=function(){this.view.graphics.clear(),this.view.graphics.beginFill(16711680),this.view.graphics.drawRect(0,0,60,30),this.view.graphics.endFill()},i.onExit=function(){this.view.graphics.clear(),null!=this.view.parent&&this.view.parent.removeChild(this.view)},t}(Component);egret.registerClass(PlayerView,"PlayerView");