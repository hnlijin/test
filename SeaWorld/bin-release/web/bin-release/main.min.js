var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var n=(__define,t),o=n.prototype;return o.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},o.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var n=(__define,t),o=n.prototype;return o.onAddToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},o.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},o.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},o.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},o.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},o.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},o.createGameScene=function(){var e={};e.server_info={},e.server_info.host=RES.getRes("gameconfig_json").host,e.server_info.port=RES.getRes("gameconfig_json").port,e.map={},(new Game).startup(this,e)},t}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var Game=function(){function e(){}var t=(__define,e),n=t.prototype;return n.startup=function(e,t){var n=new GameScene(e);n.data=t,n.setBackground(new MapBackground),n.addComponent("net",new NetSevice(t.server_info.host,t.server_info.port)),n.addComponent("logic",new GameLogicComponent(n)),GameScene.currentScene=n},e}();egret.registerClass(Game,"Game");var Component=function(e){function t(){e.call(this)}__extends(t,e);var n=(__define,t),o=n.prototype;return o.onEnter=function(){},o.onEixt=function(){},t}(egret.EventDispatcher);egret.registerClass(Component,"Component");var GameMap=function(e){function t(){e.call(this),this._map={}}__extends(t,e);var n=(__define,t),o=n.prototype;return o.addGameObject=function(e){var t=e.data.id;this.addChild(e),this._map[t]=e},o.removeGameObject=function(e){var t=e.data.id;e.removeAllComponent(),this.removeChild(e),delete this._map[t]},o.removeGameObjectForId=function(e){var t=this._map[e];null!=t&&this.removeGameObject(t)},o.getGameObjectForId=function(e){return this._map[e]},o.removeAllGameObject=function(){var e=0;for(var t in this._map)e=parseInt(t),console.log(e,typeof e),this.removeGameObjectForId(e)},t}(egret.DisplayObjectContainer);egret.registerClass(GameMap,"GameMap");var GameObject=function(e){function t(t,n){e.call(this),this._map=null,this._data=null,this._components={},this._map=t,this._data=n}__extends(t,e);var n=__define,o=t,i=o.prototype;return i.updatePosition=function(e,t){this.x=e,this.y=t},n(i,"data",function(){return this._data},function(e){this._data=e}),i.addComponent=function(e,t){this._components[e]=t,t.onEnter()},i.getComponent=function(e){return this._components[e]},i.removeComponent=function(e){var t=this._components[e];null!=t&&(t.onEixt(),delete this._components[e])},i.removeAllComponent=function(){for(var e in this._components)this.removeComponent(e)},t}(egret.DisplayObjectContainer);egret.registerClass(GameObject,"GameObject");var GameScene=function(){function e(e){this._background=null,this._gameMap=null,this._ui=null,this._tip=null,this._components={},this._data=null,this._background=new egret.DisplayObjectContainer,this._gameMap=new GameMap,this._ui=new egret.DisplayObjectContainer,this._tip=new egret.DisplayObjectContainer,e.addChild(this._background),e.addChild(this._gameMap),e.addChild(this._ui),e.addChild(this._tip)}var t=__define,n=e,o=n.prototype;return t(e,"currentScene",function(){return e._currentScene},function(t){e._currentScene=t}),t(o,"data",function(){return this._data},function(e){this._data=e}),o.addComponent=function(e,t){this._components[e]=t,t.onEnter()},o.getComponent=function(e){return this._components[e]},o.removeComponent=function(e){var t=this._components[e];null!=t&&(t.onEixt(),delete this._components[e])},o.removeAllComponent=function(){for(var e in this._components)this.removeComponent(e)},t(o,"map",function(){return this._gameMap}),o.setBackground=function(e){this._background.removeChildren(),this._background.addChildAt(e,0)},o.getBackground=function(){return this._background},e._currentScene=null,e}();egret.registerClass(GameScene,"GameScene");var GameFactory=function(){function e(){}var t=(__define,e);t.prototype;return e.createGameObject=function(e,t){if(null!=t){var n=new GameObject(e,t);return n.addComponent("view",new PlayerView(n)),n}return null},e}();egret.registerClass(GameFactory,"GameFactory");var GameLogicComponent=function(e){function t(t){e.call(this),this._ower=null,this._netSevice=null,this._ower=t,this._netSevice=this._ower.getComponent("net"),this._netSevice.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this)}__extends(t,e);var n=(__define,t),o=n.prototype;return o.onReceiveMessage=function(e){var n=0,o=e.data,i=o.dataView.getUint8(n);switch(n+=1,console.log("packetId:",i),i){case t.ADD_PLAYER:var r=o.dataView.getUint8(n);n+=1;for(var a=0;r>a;a++){var s=o.dataView.getUint8(n);n+=1;var c="",d=0,h=0,l=o.dataView.getUint8(n);n+=1;for(var u=0;l>u;u+=1){var g=o.dataView.getUint16(n,!0);n+=2,g>0&&(c+=String.fromCharCode(g))}d=o.dataView.getInt32(n),n+=4,h=o.dataView.getInt32(n),n+=4,console.log("add_player:",s,l,c,d,h);var v={};v.id=s,v.name=c;var m=GameFactory.createGameObject(this._ower.map,v);m.updatePosition(d,h),this._ower.map.addGameObject(m)}break;case t.UPDATE_PLAYER:var _=o.dataView.getUint8(n);n+=1;for(var a=0;_>a;a+=1){var s=o.dataView.getUint8(n);n+=1;var d=o.dataView.getInt32(n);n+=4;var h=o.dataView.getInt32(n);if(n+=4,console.log("update_player:",a,s,d,h),s>0){var m=this._ower.map.getGameObjectForId(s);null!=m&&m.updatePosition(d,h)}}break;case t.REMOVE_PALYER:var s=o.dataView.getUint8(n);n+=1,console.log("remove_player:",s),s>0&&this._ower.map.removeGameObjectForId(s);break;case t.ADD_FISH:var r=o.dataView.getUint8(n);n+=1;for(var a=0;r>a;a++){var s=o.dataView.getUint8(n);n+=1;var c="",d=0,h=0,l=o.dataView.getUint8(n);n+=1;for(var u=0;l>u;u+=1){var g=o.dataView.getUint16(n,!0);n+=2,g>0&&(c+=String.fromCharCode(g))}d=o.dataView.getInt32(n),n+=4,h=o.dataView.getInt32(n),n+=4,console.log("add_fish:",a,"=>",s,l,c,d,h,n);var v={};v.id=s,v.name=c;var m=GameFactory.createGameObject(this._ower.map,v);m.updatePosition(d,h),this._ower.map.addGameObject(m)}break;case t.UPDATE_FISH:var _=o.dataView.getUint8(n);n+=1;for(var a=0;_>a;a+=1){var s=o.dataView.getUint8(n);n+=1;var d=o.dataView.getInt32(n);n+=4;var h=o.dataView.getInt32(n);if(n+=4,console.log("update_fish:",a,s,d,h),s>0){var m=this._ower.map.getGameObjectForId(s);null!=m&&m.updatePosition(d,h)}}break;case t.REMOVE_FISH:var s=o.dataView.getUint8(n);n+=1,console.log("remove_fish:",s),s>0&&this._ower.map.removeGameObjectForId(s)}},t.GAME_READY=1,t.GAME_START=2,t.ADD_PLAYER=10,t.REMOVE_PALYER=11,t.UPDATE_PLAYER=12,t.ADD_FISH=20,t.UPDATE_FISH=21,t.REMOVE_FISH=22,t}(Component);egret.registerClass(GameLogicComponent,"GameLogicComponent");var MapBackground=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStge,this)}__extends(t,e);var n=(__define,t),o=n.prototype;return o.onAddToStge=function(e){this.stage.addEventListener(egret.Event.RESIZE,this.onStageResize,this),this.onResize()},o.onStageResize=function(e){this.onResize()},o.onResize=function(){},t}(egret.Sprite);egret.registerClass(MapBackground,"MapBackground");var NetSevice=function(e){function t(t,n){e.call(this),this.webSocket=null,this.webSocket=new egret.WebSocket,this.webSocket.type=egret.WebSocket.TYPE_BINARY,this.webSocket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),this.webSocket.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this.webSocket.addEventListener(egret.Event.CLOSE,this.onSocketClose,this),this.webSocket.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onSockeError,this),this.webSocket.connect(t,n)}__extends(t,e);var n=(__define,t),o=n.prototype;return o.onReceiveMessage=function(e){var t=new egret.ByteArray;this.webSocket.readBytes(t),e.data=t,this.dispatchEvent(e)},o.onSocketOpen=function(e){console.log("Socket连接成功！")},o.onSocketClose=function(e){console.log("Socket连接断开！")},o.onSockeError=function(e){console.log("Socket连接出错！")},t}(Component);egret.registerClass(NetSevice,"NetSevice");var PlayerView=function(e){function t(t){e.call(this),this.gameObject=t,this.view=new egret.Sprite,this.gameObject.addChild(this.view),this.label=new egret.TextField,this.label.textColor=65280,this.label.text=this.gameObject.data.name,this.view.addChild(this.label)}__extends(t,e);var n=(__define,t),o=n.prototype;return o.onEnter=function(){this.view.graphics.clear(),this.view.graphics.beginFill(16711680),this.view.graphics.drawRect(0,0,60,30),this.view.graphics.endFill()},o.onExit=function(){this.view.graphics.clear(),null!=this.view.parent&&this.view.parent.removeChild(this.view)},t}(Component);egret.registerClass(PlayerView,"PlayerView");