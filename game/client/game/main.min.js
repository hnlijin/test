var __reflect=this&&this.__reflect||function(e,t,o){e.__class__=t,o?o.push(t):o=[t],e.__types__=e.__types__?o.concat(e.__types__):o},__extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},Component=function(e){function t(){return e.call(this)||this}return __extends(t,e),t.prototype.onEnter=function(){},t.prototype.onEixt=function(){},t}(egret.EventDispatcher);__reflect(Component.prototype,"Component");var Main=function(e){function t(){var t=e.call(this)||this;return t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAddToStage,t),t}return __extends(t,e),t.prototype.onAddToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},t.prototype.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},t.prototype.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},t.prototype.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},t.prototype.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},t.prototype.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},t.prototype.createGameScene=function(){var e={};e.server_info={},e.server_info.host="127.0.0.1",e.server_info.port=9001,e.map={},(new Game).startup(this,e)},t}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var GameObject=function(e){function t(t,o){var n=e.call(this)||this;return n._map=null,n._data=null,n._components={},n._map=t,n._data=o,n}return __extends(t,e),t.prototype.updatePosition=function(e,t){this.x=e,this.y=t},Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e},enumerable:!0,configurable:!0}),t.prototype.addComponent=function(e,t){this._components[e]=t,t.onEnter()},t.prototype.getComponent=function(e){return this._components[e]},t.prototype.removeComponent=function(e){var t=this._components[e];null!=t&&(t.onEixt(),delete this._components[e])},t.prototype.removeAllComponent=function(){for(var e in this._components)this.removeComponent(e)},t}(egret.DisplayObjectContainer);__reflect(GameObject.prototype,"GameObject");var GameScene=function(){function e(e){this._background=null,this._gameMap=null,this._ui=null,this._tip=null,this._components={},this._data=null,this._background=new egret.DisplayObjectContainer,this._gameMap=new GameMap,this._ui=new egret.DisplayObjectContainer,this._tip=new egret.DisplayObjectContainer,e.addChild(this._background),e.addChild(this._gameMap),e.addChild(this._ui),e.addChild(this._tip)}return Object.defineProperty(e,"currentScene",{get:function(){return e._currentScene},set:function(t){e._currentScene=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e},enumerable:!0,configurable:!0}),e.prototype.addComponent=function(e,t){this._components[e]=t,t.onEnter()},e.prototype.getComponent=function(e){return this._components[e]},e.prototype.removeComponent=function(e){var t=this._components[e];null!=t&&(t.onEixt(),delete this._components[e])},e.prototype.removeAllComponent=function(){for(var e in this._components)this.removeComponent(e)},Object.defineProperty(e.prototype,"map",{get:function(){return this._gameMap},enumerable:!0,configurable:!0}),e.prototype.setBackground=function(e){this._background.removeChildren(),this._background.addChildAt(e,0)},e.prototype.getBackground=function(){return this._background},e}();GameScene._currentScene=null,__reflect(GameScene.prototype,"GameScene");var Game=function(){function e(){}return e.prototype.startup=function(e,t){var o=new GameScene(e);o.data=t,o.setBackground(new MapBackground),o.addComponent("net",new NetSevice(t.server_info.host,t.server_info.port)),o.addComponent("logic",new GameLogicComponent(o)),GameScene.currentScene=o},e}();__reflect(Game.prototype,"Game");var GameFactory=function(){function e(){}return e.createGameObject=function(e,t){if(null!=t){var o=new GameObject(e,t);return o.addComponent("view",new PlayerView(o)),o}return null},e}();__reflect(GameFactory.prototype,"GameFactory");var GameMap=function(e){function t(){var t=e.call(this)||this;return t._map={},t}return __extends(t,e),t.prototype.addGameObject=function(e){var t=e.data.id;this.addChild(e),this._map[t]=e},t.prototype.removeGameObject=function(e){var t=e.data.id;e.removeAllComponent(),this.removeChild(e),delete this._map[t]},t.prototype.removeGameObjectForId=function(e){var t=this._map[e];null!=t&&this.removeGameObject(t)},t.prototype.getGameObjectForId=function(e){return this._map[e]},t.prototype.removeAllGameObject=function(){var e=0;for(var t in this._map)e=parseInt(t),console.log(e,typeof e),this.removeGameObjectForId(e)},t}(egret.DisplayObjectContainer);__reflect(GameMap.prototype,"GameMap");var MapBackground=function(e){function t(){var t=e.call(this)||this;return t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAddToStge,t),t}return __extends(t,e),t.prototype.onAddToStge=function(e){this.stage.addEventListener(egret.Event.RESIZE,this.onStageResize,this),this.onResize()},t.prototype.onStageResize=function(e){this.onResize()},t.prototype.onResize=function(){this.graphics.clear(),this.graphics.beginFill(65280),this.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),this.graphics.endFill()},t}(egret.Sprite);__reflect(MapBackground.prototype,"MapBackground");var NetSevice=function(e){function t(t,o){var n=e.call(this)||this;return n.webSocket=null,n.webSocket=new egret.WebSocket,n.webSocket.type=egret.WebSocket.TYPE_BINARY,n.webSocket.addEventListener(egret.ProgressEvent.SOCKET_DATA,n.onReceiveMessage,n),n.webSocket.addEventListener(egret.Event.CONNECT,n.onSocketOpen,n),n.webSocket.addEventListener(egret.Event.CLOSE,n.onSocketClose,n),n.webSocket.addEventListener(egret.IOErrorEvent.IO_ERROR,n.onSockeError,n),n.webSocket.connect(t,o),n}return __extends(t,e),t.prototype.onReceiveMessage=function(e){var t=new egret.ByteArray;this.webSocket.readBytes(t),e.data=t,this.dispatchEvent(e)},t.prototype.onSocketOpen=function(e){console.log("Socket连接成功！")},t.prototype.onSocketClose=function(e){console.log("Socket连接断开！")},t.prototype.onSockeError=function(e){console.log("Socket连接出错！")},t}(Component);__reflect(NetSevice.prototype,"NetSevice");var PlayerView=function(e){function t(t){var o=e.call(this)||this;return o.gameObject=t,o.view=new egret.Sprite,o.gameObject.addChild(o.view),o.label=new egret.TextField,o.label.textColor=65280,o.label.text=o.gameObject.data.name,o.view.addChild(o.label),o}return __extends(t,e),t.prototype.onEnter=function(){this.view.graphics.clear(),this.view.graphics.beginFill(16711680),this.view.graphics.drawRect(0,0,60,30),this.view.graphics.endFill()},t.prototype.onExit=function(){this.view.graphics.clear(),null!=this.view.parent&&this.view.parent.removeChild(this.view)},t}(Component);__reflect(PlayerView.prototype,"PlayerView");var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.createView(),t}return __extends(t,e),t.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},t.prototype.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var GameLogicComponent=function(e){function t(t){var o=e.call(this)||this;return o._ower=null,o._netSevice=null,o._ower=t,o._netSevice=o._ower.getComponent("net"),o._netSevice.addEventListener(egret.ProgressEvent.SOCKET_DATA,o.onReceiveMessage,o),o}return __extends(t,e),t.prototype.onReceiveMessage=function(e){var o=0,n=e.data,r=n.dataView.getUint8(o);switch(console.log("packetId:",r),r){case t.ADD_PLAYER:o+=1;var i=n.dataView.getUint8(o),a="";o+=1;var s=n.dataView.getUint8(o);o+=1;for(var c=0;s>c;c+=1){var p=n.dataView.getUint16(2*c+o,!0);if(0==p)break;a+=String.fromCharCode(p)}console.log("add_player:",i,s,a);var d={};d.id=i,d.name=a;var l=GameFactory.createGameObject(this._ower.map,d);this._ower.map.addGameObject(l);break;case t.REMOVE_PALYER:var i=n.dataView.getUint8(o+=1);console.log("remove_player:",i),i>0&&this._ower.map.removeGameObjectForId(i);break;case t.UPDATE_PLAYER:for(var s=n.dataView.getUint8(o+=1),c=0;s>c;c+=1){var i=n.dataView.getUint8(o+=1),u=n.dataView.getUint8(o+=1),h=n.dataView.getUint8(o+=1);if(i>0){var l=this._ower.map.getGameObjectForId(i);null!=l&&l.updatePosition(u,h)}}break;case t.UPDATE_FISH:}},t}(Component);GameLogicComponent.GAME_READY=1,GameLogicComponent.GAME_START=2,GameLogicComponent.ADD_PLAYER=10,GameLogicComponent.REMOVE_PALYER=11,GameLogicComponent.UPDATE_PLAYER=12,GameLogicComponent.UPDATE_FISH=13,__reflect(GameLogicComponent.prototype,"GameLogicComponent");