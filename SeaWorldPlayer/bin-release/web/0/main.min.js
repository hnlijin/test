var __reflect=this&&this.__reflect||function(t,e,o){t.__class__=e,o?o.push(e):o=[e],t.__types__=t.__types__?o.concat(t.__types__):o},__extends=this&&this.__extends||function(t,e){function o(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)},JoystickCommon=function(t){function e(){var e=t.call(this)||this;e.joystickBG=null,e.joystickDot=null,e.radius=100,e.offsetX=0,e.offsetY=0,e.touchEnabled=!0,e.joystickBG=new egret.Bitmap;var o=RES.getRes("JoystickBG_png");e.joystickBG.texture=o,e.addChild(e.joystickBG),e.joystickDot=new egret.Bitmap;var o=RES.getRes("Joystick_png");return e.joystickDot.texture=o,e.addChild(e.joystickDot),e.radius=e.joystickBG.width/2-e.joystickDot.width/3,e.resetPosition(),e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.resetPosition=function(){this.joystickBG.x=-this.joystickBG.width/2,this.joystickBG.y=-this.joystickBG.height/2,this.joystickDot.x=-this.joystickDot.width/2,this.joystickDot.y=-this.joystickDot.height/2},e.prototype.onAddToStage=function(t){this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchCancel,this)},e.prototype.onTouchBegin=function(t){},e.prototype.onTouchMove=function(t){var e=this.globalToLocal(t.stageX,t.stageY),o=e.x,i=e.y;Math.abs(o)>this.radius&&(o>0?o=this.radius:0>o&&(o=-this.radius)),Math.abs(i)>this.radius&&(i>0?i=this.radius:0>i&&(i=-this.radius)),this.joystickDot.x=o-this.joystickDot.width/2,this.joystickDot.y=i-this.joystickDot.height/2,(this.offsetX!=o||this.offsetY!=i)&&(this.offsetX=o,this.offsetY=i,this.dispatchEvent(new egret.Event(egret.Event.CHANGE,!1,!1,{x:this.offsetX,y:this.offsetY})))},e.prototype.onTouchEnd=function(t){this.resetPosition()},e.prototype.onTouchCancel=function(t){this.resetPosition()},e}(egret.DisplayObjectContainer);__reflect(JoystickCommon.prototype,"JoystickCommon");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){var t=this.stage.stageWidth,e=this.stage.stageHeight,o=RES.getRes("gameconfig_json").host,i=RES.getRes("gameconfig_json").port;this.netSevice=new NetSevice(o,i),this.netSevice.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),this.netSevice.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this.netSevice.addEventListener(egret.Event.CLOSE,this.onSocketClose,this),this.netSevice.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onSockeError,this);var s=new egret.TextField;this.addChild(s),s.width=t/2,s.x=t/2-s.width/2,s.y=e/2,s.size=24,s.border=!0,s.borderColor=16711680,s.textColor=16777215,s.textAlign=egret.HorizontalAlign.CENTER,s.type=egret.TextFieldType.INPUT,this.textfield=s,this.desc=new egret.TextField,this.desc.text="输入昵称加入游戏",this.desc.size=18,this.desc.x=t/2-this.desc.width/2,this.desc.y=s.y-this.desc.height-10,this.addChild(this.desc);var n=new MButton(16711680,150,45,"Join Game",20);this.addChild(n),n.x=t/2-n.width/2,n.y=s.y+s.height+5,n.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onOkClick,this),n.touchEnabled=!1,this.okButton=n,this.txtMessages=new egret.TextField,this.txtMessages.text="",this.txtMessages.size=16,this.txtMessages.textAlign=egret.HorizontalAlign.CENTER,this.txtMessages.width=t,this.txtMessages.height=50,this.txtMessages.y=e-this.txtMessages.height,this.addChild(this.txtMessages),this.joystickCommon=new JoystickCommon,this.joystickCommon.x=t/2,this.joystickCommon.y=e/2,this.joystickCommon.addEventListener(egret.Event.CHANGE,this.onJoystickCommonChange,this),this.addChild(this.joystickCommon),this.reset()},e.prototype.reset=function(){this.joystickCommon.visible=!1,this.textfield.visible=!0,this.okButton.visible=!0,this.desc.visible=!0},e.prototype.onReceiveMessage=function(t){},e.prototype.onSocketOpen=function(t){this.txtMessages.text="Socket连接成功！",this.okButton.touchEnabled=!0,this.reset()},e.prototype.onSocketClose=function(t){this.txtMessages.text="Socket连接断开！",this.okButton.touchEnabled=!1,this.reset()},e.prototype.onSockeError=function(t){this.txtMessages.text="Socket连接出错！",this.okButton.touchEnabled=!1,this.reset()},e.prototype.onOkClick=function(t){return 0==this.netSevice.connected?(this.reset(),void(this.txtMessages.text="网络连接断开，请重新刷新页面")):void(this.textfield.text.length>0?(this.netSevice.joinGame(this.textfield.text),this.joystickCommon.visible=!0,this.textfield.visible=!1,this.okButton.visible=!1,this.desc.visible=!1):this.txtMessages.text="请输入昵称！")},e.prototype.onJoystickCommonChange=function(t){var e=t.data,o=e.x,i=e.y;this.netSevice.gameControl(o,i)},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var MButton=function(t){function e(e,o,i,s,n){void 0===n&&(n=20);var r=t.call(this)||this;return r._label=null,r._btnWidth=100,r._btnHeight=100,r._btnWidth=o,r._btnHeight=i,r.graphics.beginFill(e),r.graphics.drawRect(0,0,o,i),r._label=new egret.TextField,r._label.size=n,r._label.text=s,r.addChild(r._label),r.updateLayout(),r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_BEGIN,r.onTouchBegin,r),r.addEventListener(egret.TouchEvent.TOUCH_END,r.onTouchEnd,r),r.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,r.onTouchCancel,r),r}return __extends(e,t),Object.defineProperty(e.prototype,"label",{get:function(){return this._label.text},set:function(t){this._label.text=t,this.updateLayout()},enumerable:!0,configurable:!0}),e.prototype.onTouchBegin=function(t){this.alpha=.8},e.prototype.onTouchEnd=function(t){this.alpha=1},e.prototype.onTouchCancel=function(t){this.alpha=1},e.prototype.updateLayout=function(){this._label.x=(this._btnWidth-this._label.width)/2,this._label.y=(this._btnHeight-this._label.height)/2},e}(egret.Sprite);__reflect(MButton.prototype,"MButton");var NetSevice=function(t){function e(e,o){var i=t.call(this)||this;return i.webSocket=null,i.webSocket=new egret.WebSocket,i.webSocket.type=egret.WebSocket.TYPE_BINARY,i.webSocket.addEventListener(egret.ProgressEvent.SOCKET_DATA,i.onReceiveMessage,i),i.webSocket.addEventListener(egret.Event.CONNECT,i.onSocketOpen,i),i.webSocket.addEventListener(egret.Event.CLOSE,i.onSocketClose,i),i.webSocket.addEventListener(egret.IOErrorEvent.IO_ERROR,i.onSockeError,i),i.webSocket.connect(e,o),i}return __extends(e,t),e.prototype.onReceiveMessage=function(t){var e=new egret.ByteArray;this.webSocket.readBytes(e),t.data=e,this.dispatchEvent(t)},e.prototype.onSocketOpen=function(t){this.dispatchEvent(t),console.log("Socket连接成功！")},e.prototype.onSocketClose=function(t){this.dispatchEvent(t),console.log("Socket连接断开！")},e.prototype.onSockeError=function(t){this.dispatchEvent(t),console.log("Socket连接出错！")},e.prototype.joinGame=function(t){var e=new ArrayBuffer(2+2*t.length),o=new egret.ByteArray(e);o.dataView.setUint8(0,1),o.dataView.setUint8(1,t.length);for(var i=0;i<t.length;i+=1)o.dataView.setUint16(2*i+2,t.charCodeAt(i),!0),console.log(i,2*i+2,t.charCodeAt(i));this.webSocket.writeBytes(o)},e.prototype.gameControl=function(t,e){var o=new ArrayBuffer(3),i=new egret.ByteArray(o);i.dataView.setUint8(0,2),i.dataView.setUint8(1,t),i.dataView.setUint8(2,e),this.webSocket.writeBytes(i)},Object.defineProperty(e.prototype,"connected",{get:function(){return this.webSocket.connected},enumerable:!0,configurable:!0}),e}(egret.EventDispatcher);__reflect(NetSevice.prototype,"NetSevice");